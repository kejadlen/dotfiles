- include_vars: tiddlywiki/vars.yml.private

- apt: name={{ item }} state=present
  sudo: true
  with_items:
    - nodejs
    - nodejs-legacy
    - npm

# Use TiddlyWiki from source until this fix is released:
#   https://github.com/Jermolene/TiddlyWiki5/issues/1474
#
# - npm: name=tiddlywiki global=yes state=present
#   sudo: true
#
- git: repo=https://github.com/Jermolene/TiddlyWiki5.git dest=~/TiddlyWiki5
  notify: restart tiddlywiki
- command: npm link chdir=~{{ user }}/TiddlyWiki5
  sudo: true

- command: tiddlywiki ~/tiddlywiki --init server
  args:
    creates: ~/tiddlywiki
- copy: src=tiddlywiki/nginx.conf dest=/etc/nginx/conf.d/tiddlywiki.conf
  sudo: true
  notify: reload nginx
- template: src=tiddlywiki/upstart.conf.j2 dest=/etc/init/tiddlywiki.conf
  sudo: true

- name: restart tiddlywiki
  service: name=tiddlywiki state=restarted
  sudo: true
